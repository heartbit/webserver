!function(a,b){if("function"==typeof define&&define.amd)define(["localforage","backbone","underscore"],b);else if("undefined"!=typeof module&&module.exports){var c=require("localforage"),d=require("backbone"),e=require("underscore");module.exports=b(c,d,e)}else b(a.localforage,a.Backbone,a._)}(this,function(a,b,c){function d(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function e(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()}return b.localforage={sync:function(a){var c=this,d=function(d,f,g){switch(this instanceof b.Collection?this.sync.localforageKey||(this.sync.localforageKey=a):(f.id||(f.id=f.attributes.id=e()),f.sync.localforageKey||(f.sync.localforageKey=a+"/"+f.id)),d){case"read":return f.id?c.find(f,g):c.findAll(f,g);case"create":return c.create(f,g);case"update":return c.update(f,g);case"delete":return c.destroy(f,g)}};return d._localforageNamespace=a,d},save:function(b,d){a.setItem(b.sync.localforageKey,b.toJSON(),function(e){if(b.collection){var f=b.collection,g=f.map(function(a){return f.model.prototype.sync._localforageNamespace+"/"+a.id});d=d?c.partial(d,e):void 0,a.setItem(b.collection.sync.localforageKey,g,d)}else d&&d(e)})},create:function(a,b){return this.update(a,b)},update:function(a,b){this.save(a,function(a){b.success&&b.success(a)})},find:function(b,d){a.getItem(b.sync.localforageKey,function(a){c.isEmpty(a)?d.error&&d.error():d.success&&d.success(a)})},findAll:function(b,d){a.getItem(b.sync.localforageKey,function(b){if(b&&b.length){var e=function(){d.success&&d.success(b)};e=c.after(b.length,e);for(var f=function(a,c){b[a]=c,e()},g=0;g<b.length;++g)a.getItem(b[g],c.partial(f,g))}else b=[],d.success&&d.success(b)})},destroy:function(b,c){a.removeItem(b.sync.localforageKey,function(){var a=b.toJSON();c.success&&c.success(a)})}},b.localforage});